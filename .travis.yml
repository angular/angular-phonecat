language: node_js
node_js:
  - 0.10
services:
  - docker

env: BROWSERS=firefox E2E_BROWSERS=Firefox

before_script:
  - export PR=https://api.github.com/repos/$TRAVIS_REPO_SLUG/pulls/$TRAVIS_PULL_REQUEST
  - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo `curl -s $PR | jq -r .head.ref`; fi)
  - docker build -t $DOCKER_USERNAME/angular-phonecat:$BRANCH .
  - docker run -d -p 127.0.0.1:8000:8000 $DOCKER_USERNAME/angular-phonecat:$BRANCH
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start
  - npm install
  - npm run update-webdriver

script:
  - node_modules/.bin/karma start test/karma.conf.js --single-run
  - node_modules/.bin/protractor test/protractor-conf.js

after_success:
  - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD -e $DOCKER_EMAIL
  - docker push $DOCKER_USERNAME/angular-phonecat:$BRANCH

notifications:
  slack:
    secure: "Gt5ShngVo9FnySFr8GrRg+Q59aJqzR6Tm9s7nwMHeI0DiVC48Yg06HL1F67PJtNOXKOUQuAa71Yt684qWBmQ91t7v6965ZBBy3iyjgfFGJOw9WtLQPoM3kEuP+McIyDc/zblb7sseSTmIqUcVUAUrlWqsnWpg8jeIHHpQAZyLlsE4f+3Jxx33xKAi8yFD5cEQ5ruHt12ugtoOliAmyKGang+SiogG+clVM0f06KU1dajsf9usCWN7aB7r5gbD0w4BghBXNN8HYBXnR3VXtmXOisNr0ldhHh6j6YnVLTd30JsMBI6q8Mhcb1FB4/eA1tba+0TaliOYB4y0GFAS00CWOTKUrcvDed0FYqltgsSujLx3Yfo+VMdSlpQJdUKw8v7YIvVTklTFQxFlGENDX/I2VD5OSz+vcucX87TnAud4vAu/YOBYt1d6fNdYrkfxFMEfSoE/X8Li72xj4Dw6rAWnShSOyogHbsrf7rKHZ/xgJ76xvjrPHCar+XjLD38hZugudvd4c9SyCTXaiDAY+peDamCm/9OuKRB0zgcAJOXq0Q+U8ppO4huzS77l5Mf18gLOXX1LMFAgpw52bV3yycd+KLm/ccw6cS2Iq0ezbipZH12bk7H3GxP1amb9VKwn7zwtwdE3pnsZRAS6BQI+0z5VAW4vsVbdaNTlczUmBKwSMw="
